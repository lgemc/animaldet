# RF-DETR Configuration for HerdNet 560_all Dataset
# Real-time transformer-based detection for HerdNet animal detection

# Experiment metadata
experiment:
  name: rfdetr_herdnet_560_all
  tags:
    - rfdetr
    - herdnet
    - animal-detection
    - transformer

# Random seed for reproducibility
seed: 9292

# Model configuration
model:
  # Model variant: nano, small, medium, base, large
  variant: base

  # Number of classes - HerdNet has 6 species
  num_classes: 6

  # Resolution (HerdNet patches are 560x560)
  resolution: 560

  # Architecture parameters (base variant defaults)
  encoder: dinov2_windowed_small
  hidden_dim: 256
  patch_size: 14
  num_windows: 2
  dec_layers: 4
  sa_nheads: 8
  ca_nheads: 16
  dec_n_points: 2

  # Query settings (reduced for sparse detection - max 25 objects per patch)
  num_queries: 50  # Reduced from 300 (max objects is 25, 50 provides 2x safety margin)
  num_select: 50   # Should match num_queries

  # Advanced settings
  projector_scale: ["P4"]
  out_feature_indexes: [3, 6, 9, 12]
  positional_encoding_size: 37
  group_detr: 13

  # Training flags
  two_stage: true
  bbox_reparam: true
  lite_refpoint_refine: true
  layer_norm: true
  amp: true  # Automatic Mixed Precision
  gradient_checkpointing: false

  # Loss settings
  ia_bce_loss: true
  cls_loss_coef: 1.0

  # Pretrained weights
  pretrain_weights: rf-detr-base.pth
  device: cuda

# Dataset configuration
data:
  # Dataset format: COCO format
  dataset_file: coco

  # Dataset directory - points to the converted COCO format data
  # Images are expected at: {dataset_dir}/train2017/, {dataset_dir}/val2017/, {dataset_dir}/test2017/
  dataset_dir: ${oc.env:DATA_DIR,./data}/rfdetr/herdnet/560_all

  # COCO annotation files (generated by convert_to_coco.py)
  train_annotation: ${data.dataset_dir}/annotations/instances_train2017.json
  val_annotation: ${data.dataset_dir}/annotations/instances_val2017.json

  # Data augmentation settings
  multi_scale: true  # Multi-scale training
  expanded_scales: true  # Use expanded scale range
  do_random_resize_via_padding: false
  square_resize_div_64: true

  # Background filtering (for sparse detection with many background patches)
  # 5:1 ratio = 5 background images for every 1 foreground image (~83% background)
  # Original dataset has 16.5:1 ratio (94% background) which is too high
  background_ratio: 5
  background_filter_seed: 42

  # Class names (6 species from HerdNet)
  class_names: ["species_1", "species_2", "species_3", "species_4", "species_5", "species_6"]

# Optimizer configuration
optimizer:
  lr: 1.0e-4  # Base learning rate
  lr_encoder: 1.5e-4  # Encoder learning rate
  weight_decay: 1.0e-4

  # Learning rate decay strategies
  lr_vit_layer_decay: 0.8  # Layer-wise LR decay for ViT
  lr_component_decay: 0.7  # Component-wise LR decay
  drop_path: 0.0  # Stochastic depth drop path rate

  # EMA (Exponential Moving Average) settings
  use_ema: true
  ema_decay: 0.993
  ema_tau: 100

# Training configuration
trainer:
  name: RFDETRTrainer  # Trainer registry name

  # Training duration
  epochs: 100
  batch_size: 4
  grad_accum_steps: 4  # Gradient accumulation for larger effective batch size
  num_workers: 8

  # Learning rate schedule
  warmup_epochs: 0.0  # Warmup duration in epochs
  lr_drop: 100  # Epoch to drop LR (step decay)

  # Checkpointing
  checkpoint_interval: 1  # Save checkpoint every N epochs
  work_dir: ./output/rfdetr_herdnet_560_all

  # Early stopping
  early_stopping: false
  early_stopping_patience: 10
  early_stopping_min_delta: 0.001
  early_stopping_use_ema: false

  # Logging
  tensorboard: true
  wandb: false
  project: animaldet
  run: ${experiment.name}

  # Evaluation
  run_test: true  # Run test evaluation after training

# Evaluation configuration
evaluator:
  confidence_threshold: 0.5
  nms_threshold: 0.45
  eval_on_ema: true  # Evaluate on EMA model if available

  # Additional metrics configuration
  metrics:
    f1_score:
      enabled: true
      center_threshold: 20.0  # Max distance in pixels for center-based matching (HerdNet standard)
      score_threshold: 0.5    # Min confidence score for predictions
      verbose: false          # Print detailed debug information

# Integrations configuration
integrations:
  tensorboard:
    enabled: ${trainer.tensorboard}
    log_dir: ${trainer.work_dir}/tensorboard

  wandb:
    enabled: ${trainer.wandb}
    name: ${experiment.name}
    tags: ${experiment.tags}
    project: ${trainer.project}
    notes: RF-DETR experiment for HerdNet animal detection (560_all dataset with 6 species)
